<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Rental Billing</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        .nav-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
            margin: 0.25rem;
            min-width: 150px;
            position: relative;
            overflow: hidden;
        }

        .nav-button:active {
            transform: scale(0.95);
        }

        .nav-button.register {
            background-color: #059669;
            color: white;
        }

        .nav-button.register:hover {
            background-color: #047857;
        }

        .nav-button.login {
            background-color: #2563EB;
            color: white;
        }

        .nav-button.login:hover {
            background-color: #1D4ED8;
        }

        .nav-button.logout {
            background-color: #DC2626;
            color: white;
            position: fixed;
            top: 1rem;
            right: 1rem;
            min-width: auto;
            padding: 0.5rem 1rem;
            z-index: 50;
        }

        .nav-button.logout:hover {
            background-color: #B91C1C;
        }

        .form-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            padding: 2.5rem;
            margin-top: 2rem;
            position: relative;
            overflow: hidden;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid #D1D5DB;
            margin-bottom: 1rem;
            transition: all 0.2s;
            outline: none;
            background-color: #F9FAFB;
        }

        .input-field:focus {
            border-color: #2563EB;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
            background-color: white;
        }

        .toast-message {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            padding: 1rem;
            border-radius: 0.5rem;
            z-index: 50;
            animation: slideIn 0.3s ease-out;
        }

        .toast-success {
            background-color: #D1FAE5;
            color: #065F46;
        }

        .toast-error {
            background-color: #FEE2E2;
            color: #991B1B;
        }

        @keyframes slideIn {
            from {
                transform: translateY(100%);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
    </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-purple-100 via-purple-50 to-white">
    <button id="logoutButton" class="nav-button logout hidden">
        <svg class="w-4 h-4 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
        Logout
    </button>

        <!-- Authentication Section -->
        <div id="authSection" class="container mx-auto px-4 py-16">
            <div class="max-w-md mx-auto text-center">
                <!-- Logo/Icon -->
                <div class="mb-8">
                    <svg class="w-16 h-16 mx-auto text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                              d="M9 17a2 2 0 11-4 0 2 2 0 014 0zM19 17a2 2 0 11-4 0 2 2 0 014 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                              d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m6 0a2 2 0 104 0m-4 0a2 2 0 114 0" />
                    </svg>
                </div>
    
                <h1 class="text-4xl font-bold text-gray-900 mb-2">Bill Payment System</h1>
                <p class="text-gray-600 mb-8">Access your account to start paying bills</p>
    
                <!-- Form Switch -->
                <div class="form-switch">
                    <button data-form="login">Sign In</button>
                    <button data-form="register">Register</button>
                </div>
    
                <!-- Auth Status -->
                <div id="authStatus" class="text-sm font-medium text-gray-600 mb-4"></div>
    
                <!-- Form Container -->
                <div id="formContainer" class="form-card">
                    <!-- Form content -->
                </div>
    
                <!-- Response Messages -->
                <div id="responseMessage" class="hidden mt-4"></div>
            </div>
        </div>

    <div id="mainContent" class="container mx-auto px-4 py-8 hidden">
        <div class="max-w-6xl mx-auto">
            <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
                <div class="flex items-center justify-between">
                    <h1 class="text-3xl font-bold text-gray-800">My Rental Bills</h1>
                    <div id="userInfo" class="text-gray-600"></div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Booking History</h2>
                    <div id="membershipBadge" class="px-3 py-1 text-sm rounded-full bg-purple-100 text-purple-800">
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Date
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Booking ID
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Vehicle
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Amount
                                </th>
                                <th
                                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Status
                                </th>
                            </tr>
                        </thead>
                        <tbody id="billingHistory" class="bg-white divide-y divide-gray-200">
                            <!-- Billing history -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow-lg p-6 mt-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">Paid Invoices</h2>
                    <button onclick="refreshPaidInvoices()" 
                            class="px-3 py-1 text-sm bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition-colors">
                        Refresh
                    </button>
                </div>
                <div class="overflow-x-auto">
                    <div id="paidInvoicesContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Paid invoices -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>


// Supabase client initialization
const SUPABASE_URL = 'https://wjdhhzmaclmsvaiszagk.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqZGhoem1hY2xtc3ZhaXN6YWdrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzA1NDkwMDYsImV4cCI6MjA0NjEyNTAwNn0.Vq2hU8ViVOfe7TZRHf1RWTDyfKwwvXNvlLRucnq_hJo';


// Initialize page
document.addEventListener('DOMContentLoaded', () => {
    // Initialize state
    updateAuthUI();
    
    // Add event listeners for auth buttons
    document.querySelectorAll('[data-form]').forEach(button => {
        button.addEventListener('click', (e) => {
            document.querySelectorAll('[data-form]').forEach(btn => 
                btn.classList.remove('active'));
            e.target.classList.add('active');
            showForm(e.target.dataset.form);
        });
    });

    document.getElementById('logoutButton').addEventListener('click', handleLogout);

    // Initially show login form and set active state
    const loginButton = document.querySelector('[data-form="login"]');
    if (loginButton) {
        loginButton.classList.add('active');
        showForm('login');
    }
});

async function refreshPaidInvoices() {
    await loadPaidInvoices();
    showMessage('Refreshing paid invoices...', true);
}

// Authentication Functions 
function updateAuthUI() {
    const authToken = localStorage.getItem('authToken');
    const userEmail = localStorage.getItem('userEmail');
    const authSection = document.getElementById('authSection');
    const mainContent = document.getElementById('mainContent');
    const authStatus = document.getElementById('authStatus');
    const logoutBtn = document.getElementById('logoutButton');
    const formSwitchBtns = document.querySelectorAll('.form-switch button');
    const userInfo = document.getElementById('userInfo');

    if (authToken && userEmail) {
        // User is logged in
        authSection.classList.add('hidden');
        mainContent.classList.remove('hidden');
        logoutBtn.classList.remove('hidden');
        formSwitchBtns.forEach(btn => btn.classList.add('hidden'));
        if (userInfo) userInfo.textContent = `Logged in as ${userEmail}`;

        // Load both billing history and paid invoices
        loadBillingHistory();
        loadPaidInvoices();

    } else {
        // User is not logged in
        authSection.classList.remove('hidden');
        mainContent.classList.add('hidden');
        logoutBtn.classList.add('hidden');
        formSwitchBtns.forEach(btn => btn.classList.remove('hidden'));
        if (authStatus) authStatus.textContent = 'Please log in to continue';
    }
}


function showForm(formType) {
    const container = document.getElementById('formContainer');
    const title = formType.charAt(0).toUpperCase() + formType.slice(1);
    
    container.innerHTML = `
        <h2 class="text-2xl font-bold mb-6">${title}</h2>
        <form id="userForm" class="space-y-4">
            <div>
                <input type="email" id="email" class="input-field" 
                       placeholder="Email" required>
            </div>
            <div>
                <input type="password" id="password" class="input-field" 
                       placeholder="Password" required>
            </div>
            ${formType === 'register' ? `
                <div>
                    <input type="tel" id="phoneNumber" class="input-field" 
                           placeholder="Phone Number">
                </div>
                <div>
                    <select id="membershipTier" class="input-field">
                        <option value="">Select Membership Tier</option>
                        <option value="Basic">Basic</option>
                        <option value="Premium">Premium</option>
                        <option value="VIP">VIP</option>
                    </select>
                </div>
            ` : ''}
            <button type="submit" class="nav-button ${formType}">
                ${formType === 'login' ? 'Sign In' : 'Create Account'}
            </button>
        </form>
    `;

    container.classList.remove('hidden');

    document.getElementById('userForm').addEventListener('submit', (e) => {
        e.preventDefault();
        handleSubmit(formType);
    });
}

async function handleSubmit(formType) {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    const phoneNumber = document.getElementById('phoneNumber')?.value;
    const membershipTier = document.getElementById('membershipTier')?.value;

    let endpoint = '';
    let body = {};

    switch (formType) {
        case 'register':
            endpoint = '/users/register';
            body = { email, password, phone_number: phoneNumber, membership_tier: membershipTier };
            break;
        case 'login':
            endpoint = '/users/login';
            body = { email, password };
            break;
    }

    try {
        const response = await fetch(`http://localhost:8080${endpoint}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(body)
        });

        const data = await response.json();

        if (response.ok) {
            if (formType === 'login') {
                localStorage.setItem('authToken', data.token);
                localStorage.setItem('userId', data.user_id);
                localStorage.setItem('userEmail', data.email);
                showMessage('Login successful!', true);
                updateAuthUI();
            } else {
                showMessage('Registration successful! Please log in.', true);
                showForm('login');
                // Set login button as active after registration
                document.querySelectorAll('[data-form]').forEach(btn => 
                    btn.classList.remove('active'));
                document.querySelector('[data-form="login"]').classList.add('active');
            }
        } else {
            showMessage(data.message || 'An error occurred', false);
        }
    } catch (error) {
        showMessage('Failed to process request', false);
    }
}

function handleLogout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userId');
    localStorage.removeItem('userEmail');
    updateAuthUI();
    showForm('login');
    showMessage('Logged out successfully', true);
}

function showMessage(message, isSuccess) {
    const messageDiv = document.getElementById('responseMessage');
    messageDiv.className = isSuccess ? 'success-message' : 'error-message';
    messageDiv.textContent = message;
    messageDiv.classList.remove('hidden');

    setTimeout(() => {
        messageDiv.classList.add('hidden');
    }, 3000);
}

// Billing History 
async function loadBillingHistory() {
    const userId = localStorage.getItem('userId');
    if (!userId) return;

    try {
        //fetch the user's bookings with vehicle information
        const bookingsResponse = await fetch(
            `${SUPABASE_URL}/rest/v1/bookings?user_id=eq.${userId}&select=id,vehicles(model,type),start_time,end_time,total_cost,status`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json'
                }
            }
        );

        if (!bookingsResponse.ok) throw new Error('Failed to fetch bookings');
        const bookings = await bookingsResponse.json();

        //fetch the related invoices
        const invoicesResponse = await fetch(
            `${SUPABASE_URL}/rest/v1/invoices?user_id=eq.${userId}&select=*`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json'
                }
            }
        );

        if (!invoicesResponse.ok) throw new Error('Failed to fetch invoices');
        const invoices = await invoicesResponse.json();

        // Combine data
        const combinedData = invoices.map(invoice => {
            const booking = bookings.find(b => b.id === invoice.booking_id);
            return {
                ...invoice,
                vehicle_model: booking?.vehicles?.model || 'Unknown Vehicle',
                vehicle_type: booking?.vehicles?.type || 'N/A',
                booking_start: booking?.start_time,
                booking_end: booking?.end_time
            };
        });

        displayBillingHistory(combinedData);

    } catch (error) {
        console.error('Error loading billing history:', error);
        showMessage('Failed to load billing history', false);
    }
}


async function makeAuthenticatedRequest(url, options = {}) {
    const token = localStorage.getItem('authToken');
    
    if (!token) {
        handleLogout();
        return null;
    }

    const defaultOptions = {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        }
    };

    const mergedOptions = {
        ...defaultOptions,
        ...options,
        headers: {
            ...defaultOptions.headers,
            ...(options.headers || {})
        }
    };

    try {
        const response = await fetch(url, mergedOptions);
        
        if (!response.ok) {
            if (response.status === 401) {
                handleLogout();
                showToast('Session expired. Please log in again.', false);
                return null;
            }
            throw new Error(await response.text() || response.statusText);
        }

        return await response.json();
    } catch (error) {
        console.error('Request failed:', error);
        showToast(error.message || 'Request failed', false);
        return null;
    }
}

async function validateAndRefreshToken() {
    const token = localStorage.getItem('authToken');
    if (!token) return false;

    try {
        const response = await fetch(`http://localhost:8083/api/auth/validate`, {
            headers: {
                'Authorization': `Bearer ${token}`,
                'Accept': 'application/json'
            }
        });

        if (!response.ok) {
            handleLogout();
            return false;
        }

        const data = await response.json();
        return data && data.valid === true;
    } catch (error) {
        console.error('Token validation error:', error);
        handleLogout();
        return false;
    }
}

function displayBillingHistory(invoices) {
    const container = document.getElementById('billingHistory');
    
    if (!invoices || !invoices.length) {
        container.innerHTML = `
            <tr>
                <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                    No billing history available
                </td>
            </tr>
        `;
        return;
    }

    container.innerHTML = invoices.map(invoice => `
        <tr>
            <td class="px-6 py-4 whitespace-nowrap">
                ${new Date(invoice.created_at).toLocaleDateString()}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                ${invoice.booking_id}
                ${invoice.booking_start ? `
                    <div class="text-xs text-gray-500">
                        ${new Date(invoice.booking_start).toLocaleString()} - 
                        ${new Date(invoice.booking_end).toLocaleString()}
                    </div>
                ` : ''}
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div>${invoice.vehicle_model}</div>
                <div class="text-xs text-gray-500">${invoice.vehicle_type}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm">
                    <div>Base: $${invoice.amount?.toFixed(2) || '0.00'}</div>
                    <div class="text-green-600">-$${invoice.discount_amount?.toFixed(2) || '0.00'} discount</div>
                    <div class="font-bold">Final: $${invoice.final_amount?.toFixed(2) || '0.00'}</div>
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="${getStatusClass(invoice.status)}">
                    ${invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1)}
                </span>
                ${invoice.status === 'pending' ? `
                    <button onclick="handlePayment(${invoice.id})" 
                            class="ml-2 px-3 py-1 bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200 transition-colors">
                        Pay Now
                    </button>
                ` : ''}
            </td>
        </tr>
    `).join('');
}

// Invoice generation and handling
async function handlePayment(invoiceId) {
    try {
        // update invoice status to 'paid'
        const updateResponse = await fetch(
            `${SUPABASE_URL}/rest/v1/invoices?id=eq.${invoiceId}`,
            {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({
                    status: 'paid',
                    updated_at: new Date().toISOString()
                })
            }
        );

        if (!updateResponse.ok) throw new Error('Failed to process payment');

        // Fetch complete invoice details including user email
        const invoiceResponse = await fetch(
            `${SUPABASE_URL}/rest/v1/invoices?id=eq.${invoiceId}&select=*,bookings!inner(id,start_time,end_time,total_cost,vehicle_id,vehicles(model,type,hourly_rate)),users!inner(email,membership_tier)`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                }
            }
        );

        if (!invoiceResponse.ok) throw new Error('Failed to fetch invoice details');
        const [invoiceData] = await invoiceResponse.json();

        // Generate invoice HTML
        const emailContent = generateEmailInvoiceHTML(invoiceData);

        // Send email using the correct endpoint
        const emailResponse = await fetch('http://localhost:8080/invoice/send-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('authToken')}`
            },
            body: JSON.stringify({
                recipientEmail: invoiceData.users.email,
                subject: `Invoice #${invoiceId} - Payment Confirmation`,
                invoiceHtml: emailContent
            })
        });

        if (!emailResponse.ok) {
            const errorText = await emailResponse.text();
            throw new Error(errorText || 'Failed to send invoice email');
        }

        showToast('Payment processed and invoice sent to your email!', true);
        
        // Refresh the displays
        await Promise.all([
            loadBillingHistory(),
            loadPaidInvoices()
        ]);
    } catch (error) {
        console.error('Payment processing error:', error);
        showToast(`Payment error: ${error.message}`, false);
    }
}

function generateEmailInvoiceHTML(invoice) {
    const booking = invoice.bookings;
    const vehicle = booking.vehicles;
    const user = invoice.users;
    
    const startTime = new Date(booking.start_time);
    const endTime = new Date(booking.end_time);
    const duration = (endTime - startTime) / (1000 * 60 * 60); // hours
    
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Invoice #${invoice.id}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    line-height: 1.6;
                    color: #333;
                    max-width: 800px;
                    margin: 0 auto;
                    padding: 20px;
                }
                .invoice-header {
                    text-align: center;
                    margin-bottom: 30px;
                    background-color: #f8f9fa;
                    padding: 20px;
                    border-radius: 8px;
                }
                .details-grid {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 20px;
                    margin-bottom: 30px;
                }
                .section {
                    background-color: #ffffff;
                    padding: 20px;
                    border-radius: 8px;
                    border: 1px solid #e9ecef;
                    margin-bottom: 20px;
                }
                .total {
                    font-size: 1.2em;
                    font-weight: bold;
                    color: #2563eb;
                    margin-top: 20px;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 20px;
                }
                th, td {
                    padding: 12px;
                    text-align: left;
                    border-bottom: 1px solid #e9ecef;
                }
                th {
                    background-color: #f8f9fa;
                }
                @media only screen and (max-width: 600px) {
                    .details-grid {
                        grid-template-columns: 1fr;
                    }
                    body {
                        padding: 10px;
                    }
                }
            </style>
        </head>
        <body>
            <div class="invoice-header">
                <h1 style="color: #2563eb;">EV Rental Invoice</h1>
                <p>Invoice #${invoice.id}</p>
                <p>Date: ${new Date(invoice.created_at).toLocaleDateString()}</p>
            </div>

            <div class="details-grid">
                <div class="section">
                    <h3>Customer Details</h3>
                    <p>Email: ${user.email}</p>
                    <p>Membership Tier: ${user.membership_tier}</p>
                </div>
                
                <div class="section">
                    <h3>Vehicle Details</h3>
                    <p>Model: ${vehicle.model}</p>
                    <p>Type: ${vehicle.type}</p>
                    <p>Rate: $${vehicle.hourly_rate}/hour</p>
                </div>
            </div>

            <div class="section">
                <h3>Rental Details</h3>
                <table>
                    <tr>
                        <th>Start Time</th>
                        <td>${startTime.toLocaleString()}</td>
                    </tr>
                    <tr>
                        <th>End Time</th>
                        <td>${endTime.toLocaleString()}</td>
                    </tr>
                    <tr>
                        <th>Duration</th>
                        <td>${duration.toFixed(2)} hours</td>
                    </tr>
                </table>
            </div>

            <div class="section">
                <h3>Cost Breakdown</h3>
                <table>
                    <tr>
                        <th>Base Amount</th>
                        <td>$${invoice.amount.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <th>Membership Discount</th>
                        <td>-$${invoice.discount_amount.toFixed(2)}</td>
                    </tr>
                    <tr class="total">
                        <th>Total Amount</th>
                        <td>$${invoice.final_amount.toFixed(2)}</td>
                    </tr>
                </table>
            </div>

            <div class="section">
                <p><strong>Payment Status:</strong> ${invoice.status.toUpperCase()}</p>
                <p><small>Thank you for choosing our service!</small></p>
            </div>
        </body>
        </html>
    `;
}

async function generateDetailedInvoice(invoiceId) {
    try {
        // Fetch full invoice details 
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/invoices?id=eq.${invoiceId}&select=*,bookings!inner(id,start_time,end_time,total_cost,vehicle_id,vehicles(model,type,hourly_rate)),users(email,membership_tier)`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`
                }
            }
        );

        if (!response.ok) throw new Error('Failed to fetch invoice details');
        const [invoice] = await response.json();

        // Generate invoice HTML
        const invoiceHtml = generateInvoiceHTML(invoice);

        // Show invoice in new window
        showInvoice(invoiceHtml);

        return invoiceHtml; 
    } catch (error) {
        console.error('Error generating invoice:', error);
        showMessage('Failed to generate invoice', false);
        throw error;
    }
}


function showInvoice(invoiceHtml) {
    const newWindow = window.open();
    newWindow.document.write(invoiceHtml);
    newWindow.document.close();
}



function generateInvoiceHTML(invoice) {
    const booking = invoice.bookings;
    const vehicle = booking.vehicles;
    const user = invoice.users;
    
    const startTime = new Date(booking.start_time);
    const endTime = new Date(booking.end_time);
    const duration = (endTime - startTime) / (1000 * 60 * 60); // hours
    
    return `
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Invoice #${invoice.id}</title>
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; padding: 20px; }
                .invoice-header { text-align: center; margin-bottom: 30px; }
                .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
                .section { margin-bottom: 20px; }
                .total { font-size: 1.2em; font-weight: bold; margin-top: 20px; }
                table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
            </style>
        </head>
        <body>
            <div class="invoice-header">
                <h1>EV Rental Invoice</h1>
                <p>Invoice #${invoice.id}</p>
                <p>Date: ${new Date(invoice.created_at).toLocaleDateString()}</p>
            </div>

            <div class="details-grid">
                <div class="section">
                    <h3>Customer Details</h3>
                    <p>Email: ${user.email}</p>
                    <p>Membership Tier: ${user.membership_tier}</p>
                </div>
                
                <div class="section">
                    <h3>Vehicle Details</h3>
                    <p>Model: ${vehicle.model}</p>
                    <p>Type: ${vehicle.type}</p>
                    <p>Rate: $${vehicle.hourly_rate}/hour</p>
                </div>
            </div>

            <div class="section">
                <h3>Rental Details</h3>
                <table>
                    <tr>
                        <th>Start Time</th>
                        <td>${startTime.toLocaleString()}</td>
                    </tr>
                    <tr>
                        <th>End Time</th>
                        <td>${endTime.toLocaleString()}</td>
                    </tr>
                    <tr>
                        <th>Duration</th>
                        <td>${duration.toFixed(2)} hours</td>
                    </tr>
                </table>
            </div>

            <div class="section">
                <h3>Cost Breakdown</h3>
                <table>
                    <tr>
                        <th>Base Amount</th>
                        <td>$${invoice.amount.toFixed(2)}</td>
                    </tr>
                    <tr>
                        <th>Membership Discount</th>
                        <td>-$${invoice.discount_amount.toFixed(2)}</td>
                    </tr>
                    <tr class="total">
                        <th>Total Amount</th>
                        <td>$${invoice.final_amount.toFixed(2)}</td>
                    </tr>
                </table>
            </div>

            <div class="section">
                <p><strong>Payment Status:</strong> ${invoice.status.toUpperCase()}</p>
                <p><small>Thank you for choosing our service!</small></p>
            </div>
        </body>
        </html>
    `;
}

// load paid invoices
async function loadPaidInvoices() {
    const userId = localStorage.getItem('userId');
    if (!userId) return;

    try {
        // Fetch paid invoices with related booking and vehicle information
        const response = await fetch(
            `${SUPABASE_URL}/rest/v1/invoices?user_id=eq.${userId}&status=eq.paid&select=*,bookings!inner(id,start_time,end_time,total_cost,vehicles(model,type))`,
            {
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json'
                }
            }
        );

        if (!response.ok) throw new Error('Failed to fetch paid invoices');
        const paidInvoices = await response.json();
        displayPaidInvoices(paidInvoices);

    } catch (error) {
        console.error('Error loading paid invoices:', error);
        showMessage('Failed to load paid invoices', false);
    }
}
// display paid invoices
function displayPaidInvoices(paidInvoices) {
    const container = document.getElementById('paidInvoicesContainer');
    
    if (!paidInvoices || !paidInvoices.length) {
        container.innerHTML = `
            <div class="col-span-full text-center text-gray-500 py-8">
                No paid invoices available
            </div>
        `;
        return;
    }

    container.innerHTML = paidInvoices.map(invoice => `
        <div class="bg-gray-50 rounded-lg p-4 hover:shadow-md transition-shadow">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h3 class="font-semibold">Invoice #${invoice.id}</h3>
                    <p class="text-sm text-gray-600">
                        ${new Date(invoice.created_at).toLocaleDateString()}
                    </p>
                </div>
                <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800">
                    Paid
                </span>
            </div>
            
            <div class="space-y-2 mb-3">
                <div class="text-sm">
                    <span class="text-gray-600">Vehicle:</span> 
                    ${invoice.bookings?.vehicles?.model || 'N/A'}
                </div>
                <div class="text-sm">
                    <span class="text-gray-600">Rental Period:</span><br>
                    ${new Date(invoice.bookings?.start_time).toLocaleString()} - 
                    ${new Date(invoice.bookings?.end_time).toLocaleString()}
                </div>
                <div class="text-sm font-medium">
                    <span class="text-gray-600">Amount:</span> 
                    $${invoice.final_amount.toFixed(2)}
                </div>
            </div>
            
            <div class="flex justify-end space-x-2">
                <button onclick="generateDetailedInvoice(${invoice.id})" 
                        class="px-3 py-1 text-sm bg-blue-100 text-blue-600 rounded-full hover:bg-blue-200 transition-colors">
                    View Invoice
                </button>
                <button onclick="downloadInvoice(${invoice.id})" 
                        class="px-3 py-1 text-sm bg-purple-100 text-purple-600 rounded-full hover:bg-purple-200 transition-colors">
                    Download
                </button>
            </div>
        </div>
    `).join('');
}

// download invoice
async function downloadInvoice(invoiceId) {
    try {
        // Generate invoice 
        const invoiceHtml = await generateDetailedInvoice(invoiceId);
        
        const blob = new Blob([invoiceHtml], { type: 'text/html' });
        
        // Create download 
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `invoice_${invoiceId}.html`;
        
        // Trigger download
        document.body.appendChild(a);
        a.click();
        
        // Cleanup
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showMessage('Invoice downloaded successfully', true);
    } catch (error) {
        console.error('Error downloading invoice:', error);
        showMessage('Failed to download invoice', false);
    }
}

// Utility Functions
function getStatusClass(status) {
    const classes = {
        'paid': 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-800',
        'pending': 'px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800',
        'overdue': 'px-2 py-1 text-xs rounded-full bg-red-100 text-red-800'
    };
    return classes[status] || classes.pending;
}

function showToast(message, isSuccess) {
    const existingToast = document.querySelector('.toast-message');
    if (existingToast) {
        existingToast.remove();
    }

    const toast = document.createElement('div');
    toast.className = `toast-message ${isSuccess ? 'toast-success' : 'toast-error'}`;
    toast.innerHTML = `
        <div class="flex items-center">
            ${isSuccess ? `
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M5 13l4 4L19 7" />
                </svg>
            ` : `
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M6 18L18 6M6 6l12 12" />
                </svg>
            `}
            ${message}
        </div>
    `;
    
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
}

// Error handling
window.addEventListener('unhandledrejection', function(event) {
    console.error('Unhandled promise rejection:', event.reason);
    showToast('An unexpected error occurred', false);
});
    </script>
</body>

</html>